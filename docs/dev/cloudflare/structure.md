# 项目结构

本文档详细介绍了 WHU.sb Cloudflare Worker 项目的目录结构和文件职责。

## 架构概述

项目采用分层架构设计，遵循单一职责原则和依赖注入模式，确保代码的可维护性和可扩展性。

### 架构层次

1. **入口层** - Worker 主入口和路由分发
2. **处理器层** - HTTP 请求处理
3. **中间件层** - 通用功能处理
4. **服务层** - 业务逻辑处理
5. **数据层** - 数据库操作和存储
6. **工具层** - 通用工具函数

## 目录结构

```
cloudflare-worker/
├── src/                    # 源代码目录
│   ├── worker.ts           # Worker主入口文件
│   ├── router.ts           # 路由配置和分发
│   ├── handlers/           # 请求处理器
│   ├── middleware/         # 中间件
│   ├── services/           # 业务服务层
│   ├── db/                 # 数据库相关
│   └── utils/              # 工具函数
├── migrations/             # 数据库迁移文件
├── tests/                  # 测试文件
├── wrangler.toml          # Wrangler配置文件
├── package.json           # 项目依赖配置
├── tsconfig.json          # TypeScript配置
├── vitest.config.ts       # Vitest测试配置
└── drizzle.config.ts      # Drizzle ORM配置
```

## 核心文件说明

### worker.ts

Worker 的主入口文件，负责：

- 初始化 Worker 环境
- 设置全局错误处理
- 配置中间件
- 分发请求到路由

**设计原则**：
- 保持入口文件简洁
- 统一错误处理
- 中间件链式调用

### router.ts

路由配置和请求分发，负责：

- 定义 API 路由规则
- 请求方法匹配
- 参数解析
- 处理器调用

**设计原则**：
- 路由配置集中管理
- 支持动态路由
- 请求参数验证

## 处理器层 (handlers/)

处理具体的 HTTP 请求，按功能模块组织。

### 设计原则

- **单一职责**: 每个处理器只处理特定类型的请求
- **依赖注入**: 通过参数传递依赖，便于测试
- **错误处理**: 统一的错误响应格式
- **参数验证**: 严格的输入参数验证

### 处理器分类

1. **管理员接口** - 系统管理相关功能
2. **AI 聊天接口** - AI 对话功能
3. **课程相关接口** - 课程数据管理
4. **健康检查接口** - 系统状态监控
5. **评价相关接口** - 用户评价管理

## 中间件层 (middleware/)

提供请求处理过程中的通用功能。

### 设计原则

- **可组合性**: 中间件可以灵活组合
- **无副作用**: 中间件不应该修改请求状态
- **错误处理**: 统一的错误捕获和处理
- **性能优化**: 避免不必要的计算

### 中间件类型

1. **错误处理中间件** - 统一错误处理
2. **认证中间件** - 用户身份验证
3. **日志中间件** - 请求日志记录
4. **CORS 中间件** - 跨域请求处理
5. **限流中间件** - 请求频率限制

## 服务层 (services/)

业务逻辑处理，按功能模块组织。

### 设计原则

- **业务分离**: 不同业务逻辑独立处理
- **接口定义**: 清晰的接口契约
- **错误处理**: 业务异常的统一处理
- **缓存策略**: 合理使用缓存提升性能

### 服务分类

1. **AI 模型服务** - AI 模型调用和管理
2. **聊天引擎服务** - 对话流程管理
3. **数据管理服务** - 数据同步和验证
4. **知识查询服务** - 知识库检索
5. **存储服务** - 文件存储管理
6. **向量服务** - 向量数据库操作

## 数据库层 (db/)

数据库相关配置和操作。

### 设计原则

- **类型安全**: 使用 TypeScript 确保类型安全
- **连接管理**: 高效的数据库连接管理
- **事务处理**: 保证数据一致性
- **性能优化**: 查询优化和索引管理

### 数据库组件

1. **模式定义** - 数据库表结构定义
2. **连接管理** - 数据库连接配置
3. **查询构建** - 类型安全的查询构建
4. **迁移管理** - 数据库版本管理

## 工具层 (utils/)

通用工具函数。

### 设计原则

- **纯函数**: 工具函数应该是纯函数
- **类型安全**: 完整的 TypeScript 类型定义
- **可测试性**: 便于单元测试
- **文档完整**: 详细的函数文档

### 工具分类

1. **响应工具** - HTTP 响应格式化
2. **验证工具** - 数据验证和清理
3. **加密工具** - 数据加密和签名
4. **时间工具** - 时间处理函数
5. **字符串工具** - 字符串处理函数

## 配置文件

### wrangler.toml

Wrangler 配置文件，包含：

- Worker 基本配置
- 环境变量设置
- 数据库绑定配置
- 存储服务配置
- AI 服务配置

### package.json

项目依赖和脚本配置，包括：

- 项目基本信息
- 依赖包管理
- 脚本命令定义
- 开发工具配置

### tsconfig.json

TypeScript 配置，确保：

- 严格的类型检查
- 现代化的 JavaScript 特性
- 模块解析配置
- 编译选项设置

## 测试目录 (tests/)

测试文件组织。

### 测试结构

```
tests/
├── setup.ts              # 测试环境设置
├── unit/                 # 单元测试
│   ├── handlers/         # 处理器测试
│   ├── services/         # 服务测试
│   └── utils/            # 工具函数测试
├── integration/          # 集成测试
└── fixtures/             # 测试数据
```

### 测试原则

- **测试覆盖**: 确保关键功能有测试覆盖
- **测试隔离**: 每个测试独立运行
- **Mock 策略**: 合理使用 Mock 对象
- **性能测试**: 包含性能基准测试

## 迁移目录 (migrations/)

数据库迁移文件。

### 迁移管理

- **版本控制**: 每个迁移都有版本号
- **回滚支持**: 支持迁移回滚
- **数据安全**: 迁移过程中的数据保护
- **测试验证**: 迁移后的数据验证

## 文件命名规范

### 命名原则

- **描述性**: 文件名应该清楚描述其功能
- **一致性**: 使用统一的命名风格
- **可读性**: 避免缩写和特殊字符
- **扩展性**: 便于后续功能扩展

### 命名约定

1. **处理器文件** - 使用功能描述命名
2. **服务文件** - 使用服务类型命名
3. **工具文件** - 使用工具功能命名
4. **测试文件** - 使用被测试文件命名加 `.test` 后缀

## 代码组织原则

### 单一职责

每个文件只负责一个特定的功能模块，避免功能混杂。这有助于：

- 提高代码可读性
- 便于维护和测试
- 减少模块间耦合
- 提升开发效率

### 依赖注入

通过参数传递依赖，而不是在模块内部直接创建。这提供了：

- 更好的测试能力
- 灵活的配置管理
- 降低模块耦合
- 便于功能扩展

### 接口分离

定义清晰的接口，避免过度耦合。这确保了：

- 模块间的松耦合
- 便于接口替换
- 提高代码复用性
- 便于团队协作

### 错误处理

统一的错误处理机制，确保错误信息的一致性和可追踪性。包括：

- 错误分类管理
- 统一错误响应格式
- 错误日志记录
- 错误监控和报警

### 类型安全

充分利用 TypeScript 的类型系统，确保代码的类型安全。这提供了：

- 编译时错误检查
- 更好的 IDE 支持
- 代码文档化
- 重构安全性

## 扩展指南

### 添加新的处理器

1. 在 `handlers/` 目录下创建新文件
2. 实现处理器函数，遵循处理器设计原则
3. 在 `router.ts` 中注册路由
4. 添加相应的单元测试和集成测试
5. 更新 API 文档

### 添加新的服务

1. 在 `services/` 目录下创建新文件
2. 实现服务类或函数，定义清晰的接口
3. 添加业务逻辑和错误处理
4. 编写单元测试
5. 更新服务文档

### 添加新的工具函数

1. 在 `utils/` 目录下创建新文件
2. 实现纯函数，添加完整的类型定义
3. 编写详细的函数文档
4. 添加单元测试
5. 确保函数可复用性

### 数据库扩展

1. 在 `db/` 目录下添加新的模式定义
2. 创建数据库迁移文件
3. 实现数据访问函数
4. 添加数据验证逻辑
5. 编写数据库测试

---

**提示**: 项目结构会随着功能需求的变化而调整，保持结构的清晰和可维护性是关键。遵循设计原则和最佳实践，确保代码质量和开发效率。
