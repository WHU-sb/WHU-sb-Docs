# D1 数据库

本文档详细介绍了 WHU.sb Cloudflare Worker 项目中 Cloudflare D1 数据库的使用方法。

## 概述

Cloudflare D1 是一个基于 SQLite 的分布式数据库，专为 Cloudflare Workers 设计。它提供了：

- **SQLite 兼容性**: 支持标准 SQL 语法
- **全球分布式**: 数据在全球范围内复制
- **自动扩展**: 无需手动管理扩展
- **事务支持**: 完整的 ACID 事务
- **类型安全**: 与 TypeScript 完美集成

## 数据库配置

### wrangler.toml 配置

在 `wrangler.toml` 文件中配置 D1 数据库绑定：

```toml
[[d1_databases]]
binding = "DB"
database_name = "whu-course-review"
database_id = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
```

### 环境变量

在 TypeScript 中定义环境变量类型：

```typescript
interface Env {
  DB: D1Database;
}
```

## 数据库模式设计

### 设计原则

- **规范化**: 遵循数据库规范化原则
- **索引优化**: 为常用查询字段创建索引
- **约束管理**: 使用适当的约束保证数据完整性
- **扩展性**: 考虑未来功能扩展需求

### 核心表结构

1. **课程表 (courses)** - 存储课程基本信息
2. **评价表 (reviews)** - 存储用户评价数据
3. **用户表 (users)** - 存储用户信息
4. **系统表 (system)** - 存储系统配置和日志

## Drizzle ORM 集成

### 安装依赖

```bash
npm install drizzle-orm
npm install -D drizzle-kit
```

### 模式定义

使用 Drizzle ORM 定义数据库模式，确保类型安全和代码可维护性。

### 数据库连接

创建数据库连接实例，配置查询日志和性能监控。

## 基本操作

### 查询操作

实现各种查询操作，包括：

- **简单查询**: 基本的 SELECT 操作
- **条件查询**: 使用 WHERE 子句过滤数据
- **排序查询**: 使用 ORDER BY 排序结果
- **分页查询**: 使用 LIMIT 和 OFFSET 实现分页

### 插入操作

实现数据插入操作，包括：

- **单条插入**: 插入单条记录
- **批量插入**: 批量插入多条记录
- **返回数据**: 使用 RETURNING 子句返回插入的数据

### 更新操作

实现数据更新操作，包括：

- **条件更新**: 根据条件更新数据
- **批量更新**: 批量更新多条记录
- **时间戳更新**: 自动更新修改时间

### 删除操作

实现数据删除操作，包括：

- **条件删除**: 根据条件删除数据
- **软删除**: 使用标记字段实现软删除
- **级联删除**: 处理关联数据的删除

## 复杂查询

### 关联查询

实现表之间的关联查询，包括：

- **内连接**: 使用 INNER JOIN 查询关联数据
- **左连接**: 使用 LEFT JOIN 查询包含空值的数据
- **多表关联**: 处理多个表之间的复杂关联

### 聚合查询

实现数据聚合操作，包括：

- **计数统计**: 使用 COUNT 函数统计记录数
- **平均值计算**: 使用 AVG 函数计算平均值
- **分组统计**: 使用 GROUP BY 进行分组统计

### 分页查询

实现高效的分页查询，包括：

- **偏移分页**: 使用 OFFSET 实现传统分页
- **游标分页**: 使用游标实现高性能分页
- **分页优化**: 优化分页查询性能

## 事务处理

### 基本事务

实现数据库事务操作，确保数据一致性：

- **事务开始**: 开始数据库事务
- **操作执行**: 在事务中执行多个操作
- **事务提交**: 提交事务或回滚事务

### 错误处理

实现事务错误处理机制：

- **异常捕获**: 捕获事务执行异常
- **自动回滚**: 发生错误时自动回滚事务
- **错误日志**: 记录事务错误信息

## 数据库迁移

### 创建迁移

使用 Drizzle Kit 创建和管理数据库迁移：

```bash
# 生成迁移文件
npm run db:generate

# 应用迁移
npm run db:migrate
```

### 迁移管理

- **版本控制**: 每个迁移都有版本号
- **回滚支持**: 支持迁移回滚操作
- **数据安全**: 迁移过程中的数据保护
- **测试验证**: 迁移后的数据验证

## 性能优化

### 索引优化

为常用查询字段创建索引，提升查询性能：

- **主键索引**: 自动创建主键索引
- **唯一索引**: 为唯一字段创建索引
- **复合索引**: 为多字段查询创建复合索引
- **覆盖索引**: 创建覆盖查询的索引

### 查询优化

优化数据库查询性能：

- **查询计划**: 分析查询执行计划
- **索引使用**: 确保查询使用合适的索引
- **查询简化**: 简化复杂的查询语句
- **缓存策略**: 合理使用查询缓存

### 连接池优化

优化数据库连接管理：

- **连接复用**: 复用数据库连接
- **连接监控**: 监控连接使用情况
- **连接限制**: 限制最大连接数
- **连接超时**: 设置连接超时时间

## 监控和调试

### 查询日志

启用查询日志，监控数据库操作：

- **日志级别**: 设置合适的日志级别
- **日志格式**: 统一的日志格式
- **日志存储**: 安全的日志存储方案
- **日志分析**: 分析日志数据

### 性能监控

监控数据库性能指标：

- **查询时间**: 监控查询执行时间
- **连接数**: 监控数据库连接数
- **错误率**: 监控数据库错误率
- **资源使用**: 监控资源使用情况

### 错误监控

监控数据库错误和异常：

- **错误分类**: 对错误进行分类管理
- **错误统计**: 统计错误发生频率
- **错误报警**: 设置错误报警机制
- **错误恢复**: 实现错误恢复策略

## 备份和恢复

### 数据备份

实现数据库备份策略：

- **全量备份**: 定期进行全量备份
- **增量备份**: 实现增量备份机制
- **备份验证**: 验证备份数据的完整性
- **备份存储**: 安全的备份存储方案

### 数据恢复

实现数据恢复机制：

- **恢复测试**: 定期测试数据恢复流程
- **恢复时间**: 优化数据恢复时间
- **数据验证**: 恢复后的数据验证
- **业务连续性**: 确保业务连续性

## 最佳实践

### 1. 使用类型安全

- **类型定义**: 为所有数据定义 TypeScript 类型
- **接口设计**: 设计清晰的数据接口
- **类型检查**: 严格使用类型检查
- **类型推断**: 利用 TypeScript 类型推断

### 2. 参数化查询

- **SQL 注入防护**: 使用参数化查询防止 SQL 注入
- **查询优化**: 参数化查询有助于查询优化
- **代码可读性**: 提高代码可读性和维护性
- **安全性**: 确保查询的安全性

### 3. 错误处理

- **异常捕获**: 捕获所有数据库异常
- **错误分类**: 对错误进行分类处理
- **用户友好**: 提供用户友好的错误信息
- **日志记录**: 记录详细的错误日志

### 4. 连接管理

- **连接复用**: 避免重复创建数据库连接
- **连接池**: 使用连接池管理连接
- **连接监控**: 监控连接使用情况
- **资源清理**: 及时清理数据库资源

### 5. 性能优化

- **索引策略**: 制定合理的索引策略
- **查询优化**: 优化数据库查询
- **缓存使用**: 合理使用缓存机制
- **监控分析**: 持续监控和分析性能

### 6. 安全考虑

- **权限控制**: 实现细粒度的权限控制
- **数据加密**: 对敏感数据进行加密
- **访问审计**: 记录数据库访问日志
- **安全更新**: 及时更新安全补丁

## 常见问题

### 1. 连接超时

- **原因分析**: 分析连接超时的原因
- **解决方案**: 调整连接超时设置
- **预防措施**: 实现连接重试机制

### 2. 查询性能问题

- **性能分析**: 分析查询性能瓶颈
- **索引优化**: 优化数据库索引
- **查询重构**: 重构低效查询

### 3. 数据一致性问题

- **事务使用**: 正确使用数据库事务
- **约束检查**: 检查数据约束设置
- **并发控制**: 实现并发控制机制

---

**提示**: D1 数据库是 Cloudflare Workers 的核心组件，合理使用可以显著提升应用性能和数据安全性。遵循最佳实践，确保数据库的稳定性和可维护性。
