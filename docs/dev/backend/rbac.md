# RBAC权限控制规范

WHU.sb 后端采用基于角色的访问控制（RBAC）系统，结合 JWT 令牌实现用户认证和权限管理。本文档主要说明权限系统的开发规范和实现方法。

## 权限模型设计

### 角色设计原则

**角色层次化**：设计清晰的角色层次结构，从匿名用户到超级管理员，每个角色都有明确的权限边界。

**角色职责单一**：每个角色应该对应特定的职责范围，避免权限过度集中或分散。

**角色可扩展性**：设计灵活的角色系统，支持动态添加和修改角色权限。

**预定义角色**：
- **匿名用户**：只能访问公开资源，如课程列表、评价查看
- **普通用户**：可以创建和管理自己的评价，查看课程信息
- **版主**：可以管理评价内容，处理举报，维护社区秩序
- **管理员**：可以管理用户、课程、评价，配置系统参数
- **超级管理员**：拥有所有权限，包括系统备份和恢复

### 权限设计原则

**权限粒度控制**：设计细粒度的权限控制，支持资源级别的权限管理。

**权限命名规范**：使用统一的权限命名格式，如 `resource:action`，便于理解和维护。

**权限分类管理**：按功能模块对权限进行分类，如用户权限、课程权限、评价权限、系统权限等。

**权限继承机制**：高级角色自动继承低级角色的权限，简化权限管理。

## JWT认证机制

### JWT设计原则

**令牌结构设计**：JWT应该包含必要的用户信息，如用户ID、角色、权限等，避免存储敏感数据。

**令牌生命周期管理**：合理设置访问令牌和刷新令牌的过期时间，平衡安全性和用户体验。

**令牌安全策略**：使用强密钥，实现令牌黑名单机制，防止令牌滥用。

### 双令牌机制

**访问令牌（Access Token）**：
- 短期有效，通常15分钟到1小时
- 包含用户身份和权限信息
- 用于API访问认证

**刷新令牌（Refresh Token）**：
- 长期有效，通常7天到30天
- 只包含用户ID信息
- 用于获取新的访问令牌

### 令牌刷新策略

**自动刷新**：在访问令牌即将过期时，自动使用刷新令牌获取新的访问令牌。

**安全刷新**：刷新令牌使用后立即失效，生成新的刷新令牌，防止重放攻击。

**异常处理**：当刷新令牌失效时，要求用户重新登录，确保安全性。

## 中间件设计规范

### 认证中间件

**必需认证中间件**：对需要认证的接口进行强制认证检查，未认证用户直接拒绝访问。

**可选认证中间件**：对可选认证的接口进行认证检查，未认证用户以匿名身份访问。

**认证信息传递**：将用户信息存储到请求上下文中，便于后续处理使用。

### 权限中间件

**权限检查中间件**：检查用户是否具有访问特定资源的权限。

**角色检查中间件**：检查用户是否具有特定的角色。

**资源权限中间件**：检查用户是否具有操作特定资源的权限，如修改自己的评价。

### 中间件执行顺序

**认证优先**：先进行认证检查，再进行权限检查，避免无效的权限检查。

**错误处理**：统一的错误响应格式，提供清晰的错误信息。

**性能优化**：缓存用户权限信息，避免频繁的数据库查询。

## 权限检查机制

### 权限检查策略

**静态权限检查**：在路由配置中静态定义权限要求，适用于固定的权限控制。

**动态权限检查**：在业务逻辑中动态检查权限，适用于复杂的权限控制。

**资源级权限检查**：检查用户是否具有操作特定资源的权限，如修改自己的评价。

### 权限缓存机制

**权限信息缓存**：将用户权限信息缓存到内存或Redis中，提高权限检查性能。

**缓存更新策略**：当用户权限发生变化时，及时更新缓存信息。

**缓存失效策略**：设置合理的缓存过期时间，确保权限信息的及时性。

## 安全最佳实践

### 令牌安全

**强密钥管理**：使用强随机密钥，定期更换密钥。

**令牌黑名单**：实现令牌黑名单机制，支持用户主动登出。

**令牌验证**：严格验证令牌的签名、过期时间等信息。

**HTTPS传输**：所有令牌传输都使用HTTPS，防止中间人攻击。

### 密码安全

**密码策略**：制定严格的密码策略，包括长度、复杂度等要求。

**密码加密**：使用安全的密码加密算法，如bcrypt。

**密码验证**：在用户注册和修改密码时进行密码强度验证。

**密码重置**：提供安全的密码重置机制，如邮箱验证。

### 会话管理

**会话超时**：设置合理的会话超时时间，自动清理过期会话。

**并发控制**：限制同一用户的并发登录数量，防止账号滥用。

**异常检测**：检测异常的登录行为，如异地登录、频繁登录失败等。

**审计日志**：记录重要的认证和授权操作，便于安全审计。

## 权限系统扩展

### 动态权限

**权限动态分配**：支持动态分配和回收用户权限。

**权限组管理**：将相关权限组织成权限组，便于批量管理。

**权限模板**：提供权限模板，快速创建特定角色的权限配置。

### 细粒度权限

**数据级权限**：支持数据级别的权限控制，如只能查看特定部门的数据。

**操作级权限**：支持操作级别的权限控制，如只能查看不能修改。

**时间级权限**：支持时间级别的权限控制，如特定时间段内的权限。

### 权限审计

**权限变更审计**：记录权限的变更历史，包括变更人、变更时间、变更内容等。

**权限使用审计**：记录权限的使用情况，包括使用人、使用时间、使用资源等。

**权限分析报告**：生成权限使用分析报告，帮助优化权限配置。

## 性能优化

### 权限检查优化

**权限缓存**：缓存用户权限信息，减少数据库查询。

**批量权限检查**：支持批量检查多个权限，提高效率。

**权限预加载**：在用户登录时预加载权限信息，避免后续查询。

### 数据库优化

**权限索引**：为权限相关字段创建合适的索引。

**权限查询优化**：优化权限查询SQL，提高查询性能。

**权限数据分区**：对权限数据进行分区，提高查询效率。

## 监控和告警

### 权限监控

**权限使用监控**：监控权限的使用情况，发现异常使用。

**权限变更监控**：监控权限的变更情况，及时发现异常变更。

**权限冲突监控**：监控权限冲突，避免权限配置错误。

### 安全告警

**异常登录告警**：检测异常登录行为，及时发送告警。

**权限滥用告警**：检测权限滥用行为，及时发送告警。

**安全事件告警**：检测安全事件，及时发送告警。

---

**总结**：RBAC权限系统应该根据业务需求进行设计，确保权限粒度和安全性平衡，提供完善的认证授权机制，支持系统的可扩展性和高性能。
