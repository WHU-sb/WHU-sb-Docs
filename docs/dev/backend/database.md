# 数据库设计规范

WHU.sb 后端支持多种数据库，包括 MySQL、PostgreSQL、SQLite 和 JSON 文件存储，使用 GORM 作为 ORM 框架。本文档主要说明数据库设计的开发规范和实现方法。

## 数据库架构设计

### 多数据库支持策略

**数据库选择原则**：
- **生产环境**：推荐使用 MySQL 8.0+ 或 PostgreSQL 13+，具备良好的性能和稳定性
- **开发环境**：使用 SQLite 3，便于快速开发和测试
- **简单存储**：JSON 文件存储适用于配置数据和简单缓存

**适配器模式**：通过统一的数据库适配器接口，实现不同数据库的透明切换，便于开发和部署。

### 数据库连接管理

**连接池配置**：合理配置连接池参数，包括最大连接数、空闲连接数、连接生命周期等，避免连接泄漏和性能问题。

**连接健康检查**：定期检查数据库连接状态，及时发现和处理连接异常。

## 数据模型设计规范

### 实体设计原则

**核心实体识别**：识别系统中的核心业务实体，如用户、课程、教师、评价等，确保实体间关系清晰。

**字段设计规范**：
- 使用有意义的字段名，遵循命名规范
- 合理选择数据类型，避免过度设计
- 设置适当的字段约束，如非空、唯一性等
- 考虑字段的可扩展性和兼容性

**关联关系设计**：
- 明确定义实体间的一对一、一对多、多对多关系
- 合理使用外键约束，确保数据完整性
- 避免过度复杂的关联关系，影响查询性能

### 模型设计最佳实践

**基础字段标准化**：所有模型都应该包含基础字段，如ID、创建时间、更新时间等，便于数据管理和审计。

**软删除策略**：使用状态字段实现软删除，而不是物理删除，保留数据完整性和可追溯性。

**统计字段优化**：对于频繁查询的统计信息，使用冗余字段存储，避免实时计算影响性能。

**JSON字段使用**：合理使用JSON字段存储灵活的数据结构，如标签、配置信息等。

## 数据库迁移规范

### 迁移策略

**版本化管理**：使用版本化的迁移文件，确保数据库结构的变更可追踪和回滚。

**自动迁移**：在开发环境中使用自动迁移，快速同步数据库结构。

**手动迁移**：在生产环境中使用手动迁移脚本，确保数据安全和一致性。

**数据种子**：提供数据种子脚本，用于初始化基础数据和测试数据。

### 迁移最佳实践

**向后兼容性**：迁移脚本应该保持向后兼容，避免破坏现有数据。

**事务处理**：使用事务包装迁移操作，确保迁移的原子性。

**性能考虑**：对于大数据量的迁移，考虑分批处理和索引优化。

**回滚策略**：为重要的迁移操作提供回滚脚本，便于问题修复。

## GORM 使用规范

### 基本操作规范

**CRUD操作**：使用GORM提供的基本CRUD方法，保持代码简洁和一致性。

**错误处理**：正确处理GORM返回的错误，避免忽略重要的错误信息。

**批量操作**：对于批量数据操作，使用GORM的批量方法，提高性能。

### 查询优化规范

**查询方法选择**：根据查询需求选择合适的查询方法，如First、Find、Take等。

**条件查询**：使用链式调用构建复杂的查询条件，保持代码可读性。

**关联查询**：合理使用Preload和Joins进行关联查询，避免N+1查询问题。

**原生SQL**：对于复杂的查询需求，合理使用原生SQL，但要注意SQL注入风险。

### 事务处理规范

**事务边界**：明确定义事务的边界，确保事务的原子性和一致性。

**嵌套事务**：谨慎使用嵌套事务，避免复杂的事务管理。

**事务回滚**：在事务失败时及时回滚，避免数据不一致。

**性能考虑**：避免长时间的事务，影响数据库性能。

## 查询优化策略

### 索引设计规范

**索引选择原则**：
- 为经常查询的字段创建索引
- 为外键字段创建索引
- 为排序和分组字段创建索引
- 避免过度索引，影响写入性能

**复合索引设计**：
- 根据查询模式设计复合索引
- 考虑索引字段的顺序，最常用的字段放在前面
- 避免冗余索引，浪费存储空间

**索引维护**：
- 定期分析索引使用情况
- 删除不必要的索引
- 重建碎片化的索引

### 查询优化技巧

**字段选择**：只查询需要的字段，避免SELECT *，减少数据传输量。

**分页查询**：使用LIMIT和OFFSET进行分页查询，避免全表扫描。

**条件优化**：优化WHERE条件，使用索引字段进行过滤。

**关联优化**：合理使用JOIN和子查询，避免复杂的嵌套查询。

**缓存策略**：对频繁查询的数据使用缓存，减少数据库压力。

## 数据一致性保障

### 约束设计

**主键约束**：为每个表设置合适的主键，确保记录的唯一性。

**外键约束**：使用外键约束确保关联数据的完整性。

**检查约束**：使用检查约束确保数据的有效性，如评分范围、状态值等。

**唯一约束**：为需要唯一性的字段设置唯一约束，如用户名、邮箱等。

### 数据验证

**应用层验证**：在应用层进行数据验证，确保数据的正确性。

**数据库层验证**：在数据库层设置约束，作为最后的数据保障。

**业务规则验证**：实现业务规则验证，确保数据的业务逻辑正确性。

## 性能监控和优化

### 性能监控

**查询性能监控**：监控慢查询，及时发现性能问题。

**连接池监控**：监控连接池使用情况，避免连接泄漏。

**索引使用监控**：监控索引使用情况，优化索引设计。

**资源使用监控**：监控数据库资源使用情况，如CPU、内存、磁盘等。

### 性能优化

**查询优化**：优化慢查询，使用合适的索引和查询方法。

**连接池优化**：根据实际负载调整连接池参数。

**缓存优化**：合理使用缓存，减少数据库访问。

**分区优化**：对于大表考虑使用分区，提高查询性能。

## 数据备份和恢复

### 备份策略

**全量备份**：定期进行全量备份，确保数据安全。

**增量备份**：使用增量备份减少备份时间和存储空间。

**备份验证**：定期验证备份数据的完整性和可用性。

**备份存储**：将备份数据存储在安全的位置，避免数据丢失。

### 恢复策略

**恢复测试**：定期测试数据恢复流程，确保恢复的可靠性。

**恢复文档**：维护详细的恢复文档，便于紧急情况下的快速恢复。

**恢复演练**：定期进行恢复演练，提高团队的应急处理能力。

## 安全规范

### 数据安全

**敏感数据加密**：对敏感数据进行加密存储，如密码、个人信息等。

**访问控制**：严格控制数据库访问权限，使用最小权限原则。

**审计日志**：记录数据库操作日志，便于安全审计。

**数据脱敏**：在测试环境中使用脱敏数据，保护用户隐私。

### SQL注入防护

**参数化查询**：使用参数化查询，避免SQL注入攻击。

**输入验证**：对用户输入进行严格验证，过滤恶意输入。

**权限控制**：使用数据库用户权限控制，限制数据库操作范围。

---

**总结**：数据库设计应该遵循规范化原则，合理使用索引和查询优化，确保数据的一致性和安全性，提供完善的备份和恢复机制，支持系统的可扩展性和高性能。
